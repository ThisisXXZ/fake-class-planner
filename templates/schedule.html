{% extends "base.html" %}

{% block title %}My Schedule - Course Planner{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-calendar-alt"></i> My Schedule</h2>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select" id="semester-select" style="width: auto;">
                    <option value="Sem1">Semester 1</option>
                    <option value="Sem2">Semester 2</option>
                    <option value="Summer">Summer Semester</option>
                </select>
                <button class="btn btn-outline-success" id="export-ics-btn">
                    <i class="fas fa-download"></i> Export to ICS
                </button>
                <button class="btn btn-outline-danger" id="clear-schedule-btn">
                    <i class="fas fa-trash"></i> Clear Schedule
                </button>
            </div>
        </div>

        <!-- 提示信息 -->
        <div class="alert alert-info mb-4">
            <h6><i class="fas fa-info-circle"></i> Instructions</h6>
            <p class="mb-2">
                • Courses are displayed directly in the timetable, click on course blocks to view details<br>
                • Conflicting courses are prevented from being added to your schedule<br>
                • No courses yet? Go to <a href="/courses" class="alert-link">Browse Courses</a> to add courses
            </p>
        </div>

        <!-- 日程表网格 -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Course Timetable</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <div id="schedule-container" class="schedule-container">
                        <div id="schedule-grid">
                            <!-- Timetable grid will be generated here -->
                        </div>
                        <div id="course-overlay">
                            <!-- Course blocks will be displayed here with absolute positioning -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 课程详情模态框 -->
<div class="modal fade" id="courseDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Course Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="course-detail-content">
                <!-- Course details will be displayed here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="remove-course-btn">
                    <i class="fas fa-trash"></i> Remove Course
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    let currentSchedule = [];
    let currentCourseToRemove = null;
    
    // 时间段定义 (9:00 - 22:00, 每1小时一个时段)
    const timeSlots = [];
    for (let hour = 9; hour <= 21; hour++) {
        timeSlots.push(`${hour.toString().padStart(2, '0')}:00`);
    }
    // 添加22:00作为结束时间
    timeSlots.push('22:00');
    
    const weekDays = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

    // 初始化页面
    loadSchedule();
    
    // 学期切换事件
    $('#semester-select').change(function() {
        loadSchedule();
    });
    
    // Export to ICS button event
    $('#export-ics-btn').click(function() {
        exportToICS();
    });
    
    // 清空日程按钮事件
    $('#clear-schedule-btn').click(function() {
        if (confirm('Are you sure you want to clear all schedules?')) {
            clearSchedule();
        }
    });

    // 移除课程按钮事件
    $('#remove-course-btn').click(function() {
        if (currentCourseToRemove) {
            removeCourse(currentCourseToRemove);
        }
    });

    function loadSchedule() {
        const semester = $('#semester-select').val();
        $.get('/api/schedule', { semester: semester }, function(data) {
            currentSchedule = data;
            generateScheduleGrid();
        });
    }

    async function generateScheduleGrid() {
        const gridContainer = $('#schedule-grid');
        const overlayContainer = $('#course-overlay');
        
        // 如果没有课程，显示提示
        if (currentSchedule.length === 0) {
            gridContainer.html(`
                <div class="text-center p-5">
                    <h5 class="text-muted">No courses scheduled</h5>
                    <p>Go to <a href="/courses">Browse Courses</a> to add courses!</p>
                </div>
            `);
            overlayContainer.empty();
            return;
        }

        // 创建基础时间表格
        createBaseGrid();
        
        // Remove conflict visualization - conflicts are now prevented at selection time

        // 获取所有课程详情并创建课程块
        const courseDetails = await getCourseDetails();
        
        // 等待DOM更新完成后再创建课程块
        setTimeout(() => {
            createCourseBlocks(courseDetails);
        }, 100);
    }
    
    function createBaseGrid() {
        const gridContainer = $('#schedule-grid');
        
        // Create basic time table
        let html = '<table class="schedule-grid-table table table-bordered table-sm">';
        
        // Table header
        html += '<thead class="table-light"><tr><th style="width: 80px;">Time</th>';
        dayNames.forEach(function(dayName) {
            html += `<th class="text-center">${dayName}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Time rows - only show empty cells, no courses
        timeSlots.forEach(function(time, timeIndex) {
            html += `<tr data-time-index="${timeIndex}"><td class="time-header">${time}</td>`;
            
            weekDays.forEach(function(day, dayIndex) {
                html += `<td class="time-cell" data-day-index="${dayIndex}" data-time-index="${timeIndex}"></td>`;
            });
            
            html += '</tr>';
        });

        html += '</tbody></table>';
        gridContainer.html(html);
    }
    
    function createCourseBlocks(courseDetails) {
        const overlayContainer = $('#course-overlay');
        overlayContainer.empty();
        
        // Create course color mapping to ensure uniqueness
        const courseColorMap = new Map();
        const uniqueCourses = [];
        
        // Get unique course list
        currentSchedule.forEach(function(item) {
            const courseKey = `${item.course_code}_${item.subclass}`;
            if (!courseColorMap.has(courseKey)) {
                courseColorMap.set(courseKey, uniqueCourses.length);
                uniqueCourses.push(courseKey);
            }
        });
        
        // Create absolutely positioned blocks for each course
        currentSchedule.forEach(function(item, index) {
            const course = courseDetails[item.course_code];
            if (course && course.subclasses[item.subclass]) {
                const subclass = course.subclasses[item.subclass];
                const courseKey = `${item.course_code}_${item.subclass}`;
                const colorIndex = courseColorMap.get(courseKey);
                
                subclass.time_slots.forEach(function(timeSlot) {
                    timeSlot.days.forEach(function(day) {
                        createCourseBlock(item, course, timeSlot, day, colorIndex);
                    });
                });
            }
        });
    }
    
    function createCourseBlock(scheduleItem, course, timeSlot, day, colorIndex) {
        const dayIndex = weekDays.indexOf(day);
        if (dayIndex === -1) return;
        
        // Calculate time position (minutes)
        const startTime = timeToMinutes(timeSlot.start_time);
        const endTime = timeToMinutes(timeSlot.end_time);
        const duration = endTime - startTime;
        
        // Calculate precise position and size
        const position = calculateProportionalPosition(dayIndex, startTime, endTime);
        
        if (!position) return;
        
        // Generate color - use assigned color index to ensure uniqueness
        const bgColor = getCourseColorByIndex(colorIndex);
        
        // Create course block HTML
        const courseBlockHtml = `
            <div class="course-block-overlay" 
                 style="
                     left: ${position.left}px;
                     top: ${position.top}px;
                     width: ${position.width}px;
                     height: ${position.height}px;
                     background-color: ${bgColor};
                 "
                 data-course-code="${course.code}"
                 data-subclass="${scheduleItem.subclass}">
                <div class="course-overlay-title">${course.code}</div>
                <div class="course-overlay-details">
                    ${scheduleItem.subclass} | ${timeSlot.venue || 'TBD'}<br>
                    ${timeSlot.start_time.substring(0,5)}-${timeSlot.end_time.substring(0,5)}
                </div>
            </div>
        `;
        
        $('#course-overlay').append(courseBlockHtml);
        
        // Bind click events for newly created course blocks
        $('#course-overlay').off('click', '.course-block-overlay').on('click', '.course-block-overlay', function(e) {
            e.stopPropagation();
            const courseCode = $(this).data('course-code');
            const subclass = $(this).data('subclass');
            showCourseDetail(courseCode, subclass);
        });
    }
    
    function timeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }
    
    
    function calculateProportionalPosition(dayIndex, startTimeMinutes, endTimeMinutes) {
        // Wait for DOM to fully load
        const table = $('.schedule-grid-table');
        if (table.length === 0) {
            console.warn('Table not found');
            return null;
        }
        
        try {
            // Basic time configuration: 9:00-22:00, one cell per hour
            const baseTimeMinutes = 9 * 60; // 9:00 AM in minutes
            
            // Get table position and size
            const headerHeight = table.find('thead').outerHeight() || 40;
            const firstDataRow = table.find('tbody tr:first');
            const firstTimeCell = firstDataRow.find(`td.time-cell:eq(${dayIndex})`);
            
            if (firstTimeCell.length === 0) {
                console.warn(`Time cell not found for dayIndex ${dayIndex}`);
                return null;
            }
            
            const timeRowHeight = firstDataRow.outerHeight() || 80; // Use actual row height
            const columnWidth = firstTimeCell.outerWidth() || 120;
            const timeColumnWidth = table.find('thead th:first').outerWidth() || 80;
            
            // Calculate course start and end minute offsets relative to 9:00
            const startOffset = startTimeMinutes - baseTimeMinutes;
            const endOffset = endTimeMinutes - baseTimeMinutes;
            
            // Calculate precise position (by minute ratio)
            const left = timeColumnWidth + (dayIndex * columnWidth) + 4;
            const top = headerHeight + (startOffset / 60) * timeRowHeight + 4;
            
            // Calculate height (by actual time duration ratio)
            const duration = endTimeMinutes - startTimeMinutes;
            const height = (duration / 60) * timeRowHeight - 8;
            const width = columnWidth - 8;
            
            console.log(`Proportional course position: 
                dayIndex=${dayIndex}, 
                startTime=${Math.floor(startTimeMinutes/60)}:${String(startTimeMinutes%60).padStart(2,'0')}, 
                endTime=${Math.floor(endTimeMinutes/60)}:${String(endTimeMinutes%60).padStart(2,'0')},
                left=${left}, top=${top}, width=${width}, height=${height},
                duration=${duration}min`);
            
            return { 
                left: Math.round(left), 
                top: Math.round(top), 
                width: Math.max(Math.round(width), 50), 
                height: Math.max(Math.round(height), 20) 
            };
        } catch (error) {
            console.error('Error calculating proportional position:', error);
            return null;
        }
    }

    async function getCourseDetails() {
        const semester = $('#semester-select').val();
        const courseDetails = {};
        
        for (const item of currentSchedule) {
            if (!courseDetails[item.course_code]) {
                try {
                    const response = await $.get(`/api/course/${item.course_code}`, { semester: semester });
                    courseDetails[item.course_code] = response;
                } catch (error) {
                    console.error(`Error loading course ${item.course_code}:`, error);
                }
            }
        }
        
        return courseDetails;
    }


    // Removed conflict checking function - conflicts are now prevented at selection time

    function getCourseColor(courseCode) {
        // 基于课程代码生成颜色
        const colors = [
            '#007bff', '#28a745', '#dc3545', '#ffc107', 
            '#17a2b8', '#6f42c1', '#fd7e14', '#20c997'
        ];
        const index = courseCode.charCodeAt(0) % colors.length;
        return colors[index];
    }
    
    function getAvailableColors() {
        // 扩展颜色调色板，移除红色（专用于冲突）
        return [
            'rgba(0, 123, 255, 0.85)',    // 蓝色
            'rgba(40, 167, 69, 0.85)',    // 绿色
            'rgba(255, 193, 7, 0.85)',    // 黄色
            'rgba(23, 162, 184, 0.85)',   // 青色
            'rgba(111, 66, 193, 0.85)',   // 紫色
            'rgba(253, 126, 20, 0.85)',   // 橙色
            'rgba(32, 201, 151, 0.85)',   // 翠绿色
            'rgba(108, 117, 125, 0.85)',  // 灰色
            'rgba(255, 20, 147, 0.85)',   // 深粉色
            'rgba(75, 0, 130, 0.85)',     // 靛蓝
            'rgba(255, 165, 0, 0.85)',    // 橘色
            'rgba(128, 0, 128, 0.85)',    // 紫色2
            'rgba(0, 191, 255, 0.85)',    // 深天蓝
            'rgba(50, 205, 50, 0.85)',    // 酸橙绿
            'rgba(255, 69, 0, 0.85)',     // 橙红色
            'rgba(72, 61, 139, 0.85)',    // 深蓝紫
            'rgba(47, 79, 79, 0.85)',     // 深石板灰
            'rgba(184, 134, 11, 0.85)',   // 深金色
            'rgba(153, 50, 204, 0.85)',   // 深兰花紫
            'rgba(0, 100, 0, 0.85)'       // 深绿色
        ];
    }
    
    function getCourseColorByIndex(index) {
        const colors = getAvailableColors();
        return colors[index % colors.length];
    }
    
    function getCourseColorRGBA(courseCode) {
        // 保留旧函数以防其他地方使用
        const colors = getAvailableColors();
        const index = courseCode.charCodeAt(0) % colors.length;
        return colors[index];
    }

    function showCourseDetail(courseCode, subclassLabel = null) {
        const semester = $('#semester-select').val();
        $.get(`/api/course/${courseCode}`, { semester: semester }, function(course) {
            const scheduleItem = currentSchedule.find(item => 
                item.course_code === courseCode && 
                (subclassLabel ? item.subclass === subclassLabel : true)
            );
            const subclass = course.subclasses[scheduleItem.subclass];
            
            let html = `
                <h4>${course.code} - ${course.title}</h4>
                <p><strong>Department:</strong> ${course.department}</p>
                <p><strong>Semester:</strong> ${course.semester}</p>
                <p><strong>Selected Class:</strong> ${scheduleItem.subclass} (Class Number: ${subclass.class_number})</p>
                <p><strong>Instructor:</strong> ${subclass.instructor}</p>
                <hr>
                <h5>Class Time Slots:</h5>
            `;

            subclass.time_slots.forEach(function(timeSlot, index) {
                html += `
                    <div class="mb-3 p-2 border rounded">
                        <strong>Time Slot ${index + 1}: ${timeSlot.days.join(', ')}</strong><br>
                        Time: ${timeSlot.start_time} - ${timeSlot.end_time}<br>
                        Venue: ${timeSlot.venue}<br>
                    </div>
                `;
            });

            $('#course-detail-content').html(html);
            currentCourseToRemove = courseCode;
            $('#courseDetailModal').modal('show');
        });
    }

    function removeCourse(courseCode) {
        const semester = $('#semester-select').val();
        $.ajax({
            url: '/api/schedule/remove',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                course_code: courseCode,
                semester: semester
            }),
            success: function(response) {
                if (response.success) {
                    $('#courseDetailModal').modal('hide');
                    loadSchedule();
                    alert('Course removed');
                }
            },
            error: function() {
                alert('Failed to remove course');
            }
        });
    }

    function clearSchedule() {
        // Clear all courses
        const semester = $('#semester-select').val();
        const promises = currentSchedule.map(item => 
            $.ajax({
                url: '/api/schedule/remove',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    course_code: item.course_code,
                    semester: semester
                })
            })
        );

        Promise.all(promises).then(() => {
            loadSchedule();
            alert('Schedule cleared');
        });
    }

    function exportToICS() {
        const semester = $('#semester-select').val();
        
        if (currentSchedule.length === 0) {
            alert('No courses in schedule to export');
            return;
        }
        
        // Create a download link for the ICS file
        const downloadUrl = `/api/schedule/export-ics?semester=${encodeURIComponent(semester)}`;
        
        // Create temporary anchor element and trigger download
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `schedule_${semester}.ics`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

});
</script>
{% endblock %}